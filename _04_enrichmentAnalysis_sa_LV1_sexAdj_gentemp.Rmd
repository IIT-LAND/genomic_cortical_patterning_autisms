---
title: "enrichmentAnalysis.Rmd"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Load data

```{r, message=FALSE, warning=FALSE}
library(easypackages)
libraries("here","pheatmap","reshape2","ggplot2","patchwork","Biobase","readxl")
source(here("code","genelistOverlap.R"))
options(stringsAsFactors = FALSE)

plspath = here("pls")
datapath = here("data","tidy")
plotdir = here("plots")

ndigits2use = 4
fdr_thresh = 0.05
fontSize = 20
dotSize = 10

mod_names = c("M1","M2","M3","M4","M5","M6","M7","M8","M9","M10",
              "M11","M12","M13","M14","M15","M16","M17","M18","M19","M20","M21")
nmods = length(mod_names)

# Load in gene lists for enrichment analyses
load(here("data","tidy","enrichment_data2.Rdata"))
load(here("data","tidy","gandal_genelists.Rdata"))
load(here("data","tidy","velmeshev_genelists.Rdata"))
load(here("data","tidy","won_genelists.Rdata"))

# wgcna_res = read.csv(here("WGCNAresults","wgcna_results_summary.csv"))
wgcna_res = read_excel(here("WGCNAresults","wgcna_results_summary.xlsx"))
backgroundTotal = dim(wgcna_res)[1]
bglist = wgcna_res$geneSymbol
M0_size = dim(subset(wgcna_res, wgcna_res$moduleLabels==0))[1]


pls_fname = "plsres_all_sa_GenTemp_sexAdj_MEcorr_bootCI4plotting_LV1_ci95.csv"
fname = here("pls","results",pls_fname)
plsbootdata = read.csv(fname)

var2use = "nonzero"

td_tmp = subset(plsbootdata, plsbootdata$Grp=="TD")
rownames(td_tmp) = 1:nmods
poor_tmp = subset(plsbootdata, plsbootdata$Grp=="Poor")
rownames(poor_tmp) = 1:nmods
good_tmp = subset(plsbootdata, plsbootdata$Grp=="Good")
rownames(good_tmp) = 1:nmods

td_mods = as.numeric(rownames(td_tmp)[td_tmp[,var2use]==1])
asd_poor_mods = as.numeric(rownames(poor_tmp)[poor_tmp[,var2use]==1])
asd_good_mods = as.numeric(rownames(good_tmp)[good_tmp[,var2use]==1])

if (identical(td_mods,numeric(0))){
  td_mods = NA
} else if (identical(asd_poor_mods,numeric(0))){
  asd_poor_mods = NA
} else if (identical(asd_good_mods,numeric(0))){
  asd_good_mods = NA
}

mask = logical(length = nmods)
nonzero_mods = sort(unique(c(td_mods, asd_poor_mods, asd_good_mods)))
mask[nonzero_mods] = TRUE
zero_mods = 1:nrow(td_tmp)
zero_mods = zero_mods[!mask]

nz_mods = mod_names[nonzero_mods]
z_mods = mod_names[zero_mods]

# non-zero and zero modules
nonzeromods = nonzero_mods
zeromods = zero_mods

# Grab non-zero modules and report percentage of genes falling within those modules
mask = is.element(wgcna_res$moduleLabels, nonzeromods)
nonzeromod_data = subset(wgcna_res, mask)
nz_genes = nonzeromod_data$geneSymbol
write(nz_genes, file = file.path(datapath,"nonzeromod_genes_SA_LV1.txt"))
# percentage of clustered genes falling within those modules
nz_prop = dim(nonzeromod_data)[1]/(backgroundTotal-M0_size)
nz_mods
nz_prop

# Grab zero modules and report percentage of genes falling within those modules
mask = is.element(wgcna_res$moduleLabels, zeromods)
zeromod_data = subset(wgcna_res, mask)
z_genes = zeromod_data$geneSymbol
write(z_genes, file = file.path(datapath,"zeromod_genes_SA_LV1.txt"))
# percentage of clustered genes falling within those modules
z_prop = dim(zeromod_data)[1]/(backgroundTotal-M0_size)
z_mods
z_prop
```

# Annotate each module by enrichment in broadly expressed and brain-specific genes

```{r, message=FALSE, warning=FALSE}
geneclasses = c("BroadGenesVG","BrainGenesVG")
outcols = c("OR","pval","fdr")

out_mats = vector(mode = "list", length = length(geneclasses))
names(out_mats) = geneclasses
for (igc in 1:length(geneclasses)){
  out_res = data.frame(matrix(nrow = length(mod_names), 
                              ncol = length(outcols)))
  colnames(out_res) = outcols
  rownames(out_res) = mod_names

  # intersect genes2 list with background 
  genes2 = eval(as.name(geneclasses[igc]))
  mask = is.element(genes2,bglist)
  genes2 = data.frame(genes2[mask])

  for (imod in 1:length(mod_names)){
    # filename for module list
    genes1 = wgcna_res$geneSymbol[wgcna_res$moduleLabels==imod]
    
    overlap_res = genelistOverlap(genes1,
                                  genes2,
                                  backgroundTotal, 
                                  print_result = FALSE, 
                                  header = FALSE)
    out_res[imod,1] = overlap_res[[1]]$OR
    out_res[imod,2] = overlap_res[[1]]$hypergeo_p
  }
  out_res[,3] = p.adjust(out_res[,2], method = "fdr")
  out_mats[[igc]] = out_res
}
```


# Modules enriched for broadly expressed genes
```{r, warning=FALSE, message=FALSE}
out_mats[[1]]
```

# Modules enriched for brain-specific genes
```{r, warning=FALSE, message=FALSE}
out_mats[[2]]
```

<!-- # At the level of modules, test non-zero and zero modules for enrichment in broadly expressed, blood, brain, or lymphocyte modules -->

<!-- ```{r, warning=FALSE, message=FALSE} -->
<!-- # broadly expressed modules -->
<!-- broadmods = mod_names[out_mats$BroadGenes$fdr<=fdr_thresh] -->

<!-- # test enrichment between non-zero modules and broadly expressed modules -->
<!-- overlap_res = genelistOverlap(nz_mods,  -->
<!--                               broadmods,  -->
<!--                               length(mod_names),  -->
<!--                               print_result = TRUE) -->

<!-- # test enrichment between zero modules and broadly expressed modules -->
<!-- overlap_res = genelistOverlap(z_mods,  -->
<!--                               broadmods,  -->
<!--                               length(mod_names),  -->
<!--                               print_result = TRUE) -->

<!-- # blood modules -->
<!-- bloodmods = mod_names[out_mats$BloodGenes$fdr<=fdr_thresh] -->

<!-- # test enrichment between non-zero modules and blood modules -->
<!-- overlap_res = genelistOverlap(nz_mods,  -->
<!--                               bloodmods,  -->
<!--                               length(mod_names),  -->
<!--                               print_result = TRUE) -->

<!-- # test enrichment between zero modules and blood modules -->
<!-- overlap_res = genelistOverlap(z_mods,  -->
<!--                               bloodmods,  -->
<!--                               length(mod_names),  -->
<!--                               print_result = TRUE) -->

<!-- # brain expressed modules -->
<!-- brainmods = mod_names[out_mats$BrainGenes$fdr<=fdr_thresh] -->

<!-- # test enrichment between non-zero modules and brain modules -->
<!-- overlap_res = genelistOverlap(nz_mods,  -->
<!--                               brainmods,  -->
<!--                               length(mod_names),  -->
<!--                               print_result = TRUE) -->

<!-- # test enrichment between zero modules and brain modules -->
<!-- overlap_res = genelistOverlap(z_mods,  -->
<!--                               brainmods,  -->
<!--                               length(mod_names),  -->
<!--                               print_result = TRUE) -->

<!-- # lymphocyte modules -->
<!-- lymphocytemods = mod_names[out_mats$LymphocyteGenes$fdr<=fdr_thresh] -->

<!-- # test enrichment between non-zero modules and lymphocyte modules -->
<!-- overlap_res = genelistOverlap(nz_mods, -->
<!--                               lymphocytemods, -->
<!--                               length(mod_names), -->
<!--                               print_result = TRUE) -->

<!-- # test enrichment between zero modules and lymphocyte modules -->
<!-- overlap_res = genelistOverlap(z_mods, -->
<!--                               lymphocytemods, -->
<!--                               length(mod_names), -->
<!--                               print_result = TRUE) -->
<!-- ``` -->

<!-- # At the level of modules, test for overlap between non-zero modules across groups -->

<!-- ```{r, warning=FALSE, message=FALSE} -->
<!-- # show the ASD Poor modules -->
<!-- asd_poor_mods = mod_names[asd_poor_mods] -->

<!-- # show the ASD Good modules -->
<!-- asd_good_mods = mod_names[asd_good_mods] -->

<!-- # show the TD modules -->
<!-- td_mods = mod_names[td_mods] -->

<!-- # test overlap between ASD Poor and ASD Good -->
<!-- overlap_res = genelistOverlap(asd_poor_mods, -->
<!--                               asd_good_mods, -->
<!--                               length(mod_names), -->
<!--                               print_result = TRUE) -->

<!-- # test overlap between TD and ASD Good -->
<!-- overlap_res = genelistOverlap(td_mods, -->
<!--                               asd_good_mods, -->
<!--                               length(mod_names), -->
<!--                               print_result = TRUE) -->

<!-- # test overlap between TD and ASD Poor -->
<!-- overlap_res = genelistOverlap(td_mods, -->
<!--                               asd_poor_mods, -->
<!--                               length(mod_names), -->
<!--                               print_result = TRUE) -->
<!-- ``` -->


# Plot correlation values across groups

## Surface Area LV1

```{r, warning=FALSE, message=FALSE}
sa_data = read.csv(file.path(plspath,"results","plsres_all_sa_GenTemp_sexAdj_MEcorr_bootCI4plotting_LV1_ci95.csv"))
sa_good = subset(sa_data,sa_data$Grp=="Good")
sa_poor = subset(sa_data,sa_data$Grp=="Poor")
sa_td = subset(sa_data,sa_data$Grp=="TD")


#------------------------------------------------------------------------------
fontSize = 18
data4heatmap = sa_data
level_ordering = rev(c("M13","M2","M16","M21","M4","M10","M6","M7","M11","M15",
                   "M20","M3","M17","M5","M19","M14","M12","M9","M8","M18","M1"))
data4heatmap$ModName = factor(data4heatmap$ModName, 
                              levels = level_ordering)
data4heatmap$Grp = factor(data4heatmap$Grp, levels = c("Poor","Good","TD")) 
me_corr_comp = data.frame(matrix(nrow = dim(data4heatmap)[1], ncol = 3))
colnames(me_corr_comp) = c("Grp","gclust","allVertices")
me_corr_comp$Grp = data4heatmap$Grp
me_corr_comp$gclust = data4heatmap$corr
p = ggplot(data = data4heatmap) + 
  geom_tile(aes(y = ModName, x = Grp, fill= corr)) + 
  geom_text(aes(y= ModName, x=Grp, label = round(corr,2)),size = 5) + 
  scale_fill_gradientn(colors = colorRampPalette(c("blue","white","red"))(100), limits=c(-0.8,0.8)) +
  # scale_fill_gradient(low = "white", high="red") + 
  ylab("")+xlab("") +
  theme(
    # Remove panel border
    panel.border = element_blank(),  
    # Remove panel grid lines
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank(),
    # Remove panel background
    panel.background = element_blank(),
    axis.text.x = element_text(size=fontSize),
    axis.text.y = element_text(size=fontSize),
    axis.title.x = element_text(size=fontSize),
    strip.text.x = element_text(size=fontSize),
    axis.title.y = element_text(size=fontSize),
    plot.title = element_text(hjust = 0.5, size=fontSize))
    
ggsave(filename = file.path(plotdir, "GCLUST_SA_sexAdj_LV1_MEcorr.pdf"), width=5,height=5)
p
#------------------------------------------------------------------------------





#------------------------------------------------------------------------------
sa_allVert_data = read.csv(file.path(plspath,"results","plsres_all_sa_allVertices_sexMeanSAAdj_MEcorr_bootCI4plotting_LV1_ci95.csv"))
# sa_good = subset(sa_data,sa_data$Grp=="Good")
# sa_poor = subset(sa_data,sa_data$Grp=="Poor")
# sa_td = subset(sa_data,sa_data$Grp=="TD")

fontSize = 18
data4heatmap = sa_allVert_data
data4heatmap$corr = data4heatmap$corr*-1
me_corr_comp$allVertices = data4heatmap$corr
level_ordering = rev(c("M13","M2","M16","M21","M4","M10","M6","M7","M11","M15",
                   "M20","M3","M17","M5","M19","M14","M12","M9","M8","M18","M1"))
data4heatmap$ModName = factor(data4heatmap$ModName, 
                              levels = level_ordering)
data4heatmap$Grp = factor(data4heatmap$Grp, levels = c("Poor","Good","TD")) 
p = ggplot(data = data4heatmap) + 
  geom_tile(aes(y = ModName, x = Grp, fill= corr)) + 
  geom_text(aes(y= ModName, x=Grp, label = round(corr,2)),size = 5) + 
  scale_fill_gradientn(colors = colorRampPalette(c("blue","white","red"))(100), limits=c(-0.8,0.8)) +
  # scale_fill_gradient(low = "white", high="red") + 
  ylab("")+xlab("") +
  theme(
    # Remove panel border
    panel.border = element_blank(),  
    # Remove panel grid lines
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank(),
    # Remove panel background
    panel.background = element_blank(),
    axis.text.x = element_text(size=fontSize),
    axis.text.y = element_text(size=fontSize),
    axis.title.x = element_text(size=fontSize),
    strip.text.x = element_text(size=fontSize),
    axis.title.y = element_text(size=fontSize),
    plot.title = element_text(hjust = 0.5, size=fontSize))
    
ggsave(filename = file.path(plotdir, "AllVertices_SA_sexMeanSAAdj_LV1_MEcorr.pdf"), width=5,height=5)
p
#------------------------------------------------------------------------------

#------------------------------------------------------------------------------
grp_names = unique(me_corr_comp$Grp)
r_mat = data.frame(matrix(nrow = length(grp_names), ncol =  2))
rownames(r_mat) = grp_names
colnames(r_mat) = c("corr","pval")
tmp_res = cor.test(me_corr_comp$gclust[me_corr_comp$Grp=="Poor"],me_corr_comp$allVertices[me_corr_comp$Grp=="Poor"])
r_mat["Poor","corr"] = tmp_res$estimate
r_mat["Poor","pval"] = tmp_res$p.value
tmp_res = cor.test(me_corr_comp$gclust[me_corr_comp$Grp=="Good"],me_corr_comp$allVertices[me_corr_comp$Grp=="Good"])
r_mat["Good","corr"] = tmp_res$estimate
r_mat["Good","pval"] = tmp_res$p.value
tmp_res = cor.test(me_corr_comp$gclust[me_corr_comp$Grp=="TD"],me_corr_comp$allVertices[me_corr_comp$Grp=="TD"])
r_mat["TD","corr"] = tmp_res$estimate
r_mat["TD","pval"] = tmp_res$p.value
r_mat$Grp = rownames(r_mat)
r_mat$x_var = "corr"

p = ggplot(data = r_mat) + 
  geom_tile(aes(y = Grp, x = x_var, fill= corr)) + 
  geom_text(aes(y= Grp, x = x_var, label = round(corr,2)),size = 5) + 
  scale_fill_gradientn(colors = colorRampPalette(c("blue","white","red"))(100), limits=c(-1,1)) +
  # scale_fill_gradient(low = "white", high="red") + 
  ylab("")+xlab("") +
  theme(
    # Remove panel border
    panel.border = element_blank(),  
    # Remove panel grid lines
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank(),
    # Remove panel background
    panel.background = element_blank(),
    axis.text.x = element_text(size=fontSize),
    axis.text.y = element_text(size=fontSize),
    axis.title.x = element_text(size=fontSize),
    strip.text.x = element_text(size=fontSize),
    axis.title.y = element_text(size=fontSize),
    plot.title = element_text(hjust = 0.5, size=fontSize))
    
ggsave(filename = file.path(plotdir, "GCLUST_AllVertices_SA_LV1_MEcorr_comp.pdf"), width=3,height=5)
r_mat
p
#------------------------------------------------------------------------------







# Surface Area
df2plot = data.frame(Good = sa_good$corr, Poor = sa_poor$corr, TD = sa_td$corr, ModName = sa_poor$ModName)

df2plot$modtype = NA
df2plot$modtype[c(2,4,6,7,16,20,21)] = "PosNonZero"
df2plot$modtype[c(1,11,14,18)] = "NegNonZero"

# p1 = ggplot(data = df2plot, aes(x = Good, y = Poor, label=ModName))
p1 = ggplot(data = df2plot, aes(x = Good, y = Poor))
p1 = p1 + geom_point(data=df2plot, aes(fill=modtype), size=dotSize, colour="black", pch=21) +
  # geom_text(colour="black") +
  geom_smooth(method=lm, colour="black")
p1 = p1 + xlab("ASD Good PLS Correlation") + ylab("ASD Poor PLS Correlation") + guides(colour=FALSE, fill=FALSE) +
  ggtitle("ASD Good vs ASD Poor") +
  scale_fill_manual(values = c("dark blue","dark red")) +
  theme(text = element_text(size=fontSize), 
        axis.text.x = element_text(size=fontSize),
        axis.text.y = element_text(size=fontSize),
        plot.title = element_text(size=fontSize,hjust=0.5))
ggsave(filename = file.path(plotdir, "plscorr_scatterplot_ASDGood_ASDPoor_SA_LV1.pdf"))
p1

cor.test(df2plot$Good, df2plot$Poor)


df2plot$modtype = NA
df2plot$modtype[c(2,10,13,16,21)] = "PosNonZero"
df2plot$modtype[c(1,11)] = "NegNonZero"

# p2 = ggplot(data = df2plot, aes(x = TD, y = Poor, label=ModName))
p2 = ggplot(data = df2plot, aes(x = TD, y = Poor))
p2 = p2 + geom_point(data=df2plot, aes(fill=modtype), size=dotSize, colour="black", pch=21) +
  # geom_text(colour="black") +
  geom_smooth(method=lm, colour="black")
p2 = p2 + xlab("TD PLS Correlation") + ylab("ASD Poor PLS Correlation") + guides(colour=FALSE, fill=FALSE) + 
  ggtitle("TD vs ASD Poor") +
  scale_fill_manual(values = c("dark blue","dark red")) +
  theme(text = element_text(size=fontSize), 
        axis.text.x = element_text(size=fontSize),
        axis.text.y = element_text(size=fontSize),
        plot.title = element_text(size=fontSize,hjust=0.5))
ggsave(filename = file.path(plotdir, "plscorr_scatterplot_TD_ASDPoor_SA_LV1.pdf"))
p2

cor.test(df2plot$TD, df2plot$Poor)


df2plot$modtype = NA
df2plot$modtype[c(2,4,6,7,10,13,16,20,21)] = "PosNonZero"
df2plot$modtype[c(1,14,18)] = "NegNonZero"

# p3 = ggplot(data = df2plot, aes(x = TD, y = Good, label=ModName))
p3 = ggplot(data = df2plot, aes(x = TD, y = Good))
p3 = p3 + geom_point(data=df2plot, aes(fill=modtype), size=dotSize, colour="black", pch=21) +
  # geom_text(colour="black") +
  geom_smooth(method=lm, colour="black")
p3 = p3 + xlab("TD PLS Correlation") + ylab("ASD Good PLS Correlation") + guides(colour=FALSE, fill=FALSE) + 
  ggtitle("TD vs ASD Good") +
  scale_fill_manual(values = c("dark blue","dark red")) +
  theme(text = element_text(size=fontSize), 
        axis.text.x = element_text(size=fontSize),
        axis.text.y = element_text(size=fontSize),
        plot.title = element_text(size=fontSize,hjust=0.5))
ggsave(filename = file.path(plotdir, "plscorr_scatterplot_TD_ASDGood_SA_LV1.pdf"))
p3

cor.test(df2plot$TD, df2plot$Good)

p_final = (p1 | p2 | p3)
p_final
```



# Examine enrichment at the gene-level between gene classes and non-zero or zero modules

```{r, warning=FALSE, message=FALSE}
geneclasses = c("BroadGenesVG","BrainGenesVG")
res_colnames = c("Non-Zero Modules","Zero Modules")

ORmat = data.frame(matrix(nrow = length(geneclasses), 
                          ncol = length(res_colnames)))
logPmat = data.frame(matrix(nrow = length(geneclasses), 
                            ncol = length(res_colnames)))
Pmat = data.frame(matrix(nrow = length(geneclasses),
                         ncol = length(res_colnames)))
FDRmat = data.frame(matrix(nrow = length(geneclasses),
                           ncol = length(res_colnames)))
NOverlapmat = data.frame(matrix(nrow = length(geneclasses), 
                          ncol = length(res_colnames)))

colnames(ORmat) = res_colnames
colnames(logPmat) = res_colnames
colnames(Pmat) = res_colnames
colnames(FDRmat) = res_colnames
colnames(NOverlapmat) = res_colnames
rownames(ORmat) = geneclasses
rownames(logPmat) = geneclasses
rownames(Pmat) = geneclasses
rownames(FDRmat) = geneclasses
rownames(NOverlapmat) = geneclasses

for (i in 1:length(geneclasses)){
  # intersect genes2 with background list
  genes2 = eval(as.name(geneclasses[i]))
  mask = is.element(genes2,bglist)
  genes2 = data.frame(genes2[mask])
  
  overlap_res = genelistOverlap(nz_genes,
                                genes2,
                                backgroundTotal,
                                print_result = FALSE,
                                header = FALSE)
  ORmat[i,1] = overlap_res[[1]]$OR
  logPmat[i,1] = -log10(overlap_res[[1]]$hypergeo_p)
  Pmat[i,1] = overlap_res[[1]]$hypergeo_p
  NOverlapmat[i,1] = overlap_res[[1]]$gene_overlap

  overlap_res = genelistOverlap(z_genes,
                                genes2,
                                backgroundTotal,
                                print_result = FALSE,
                                header = FALSE)
  ORmat[i,2] = overlap_res[[1]]$OR
  logPmat[i,2] = -log10(overlap_res[[1]]$hypergeo_p)
  Pmat[i,2] = overlap_res[[1]]$hypergeo_p
  NOverlapmat[i,2] = overlap_res[[1]]$gene_overlap
}
for (i in 1:dim(Pmat)[2]){
  FDRmat[,i] = p.adjust(Pmat[,i], method = "fdr")
}

zLIM = c(0,30)
par(mar = c(6, 8.5, 3, 3))
WGCNA::labeledHeatmap(Matrix = logPmat,
                      xLabels = colnames(ORmat), 
                      yLabels = rownames(ORmat),
                      ySymbols = NULL, 
                      colorLabels = FALSE,
                      colors = WGCNA::blueWhiteRed(100), 
                      textMatrix = round(ORmat, digits = 2),
                      setStdMargins = FALSE, 
                      cex.text = 3, 
                      zlim = zLIM)

# Enrichment Odds Ratios
ORmat

# P-values
Pmat

# FDR
FDRmat

# Noverlap
NOverlapmat

```


# All enrichments

```{r, warning=FALSE, message=FALSE}
geneclasses = list(HumanSpecific_Prenatal_Zhu,
                   HumanSpecific_EarlyPostnatal_Zhu,
                   HumanSpecific_Adult_Zhu,
                   won_har_genes,
                   won_hge_fetal_genes,
                   won_hge_adult_genes,
                   won_hle_genes,
                   W234_PC1,
                   W234_PC2,
                   SongBirdDE,
                   ASDPrenatal1,
                   gandal_asd_down,
                   gandal_asd_up,
                   ASDCTXDownreg,
                   ASDCTXUpreg,
                   ASD102,
                   SFARIASD,
                   FMRP1,
                   FMRP2,
                   CHD81,
                   CHD82,
                   gandal_scz,
                   gandal_bd,
                   excitatory_de_genes,
                   inhibitory_de_genes,
                   microglia_de_genes,
                   oligodendrocyte_de_genes,
                   astrocyte_de_genes,
                   endothelial_de_genes,
                   vRG,oRG,PgS,PgG2M,IP,
                   ExN,ExM,ExMU,ExDp1,ExDp2,
                   InMGE,InCGE,
                   OPC,End,Per,Mic)

geneclassnames = c("Human-Specific Prenatal",
                   "Human-Specific Early Postnatal",
                   "Human-Specific Adult",
                   "Human-Accelerated Genes",
                   "Human-Gained Enhancers Fetal",
                   "Human-Gained Enhancers Adult",
                   "Human-Lossed Enhancers",
                   "PC1",
                   "PC2",
                   "Song Bird DE",
                   "ASD Prenatal1",
                   "ASD DE Downreg",
                   "ASD DE Upreg",
                   "ASD CTX Downreg",
                   "ASD CTX Upreg",
                   "ASD 102 dnPTVs",
                   "SFARI ASD",
                   "FMRP Targets1",
                   "FMRP Targets2",
                   "CHD8 Targets1",
                   "CHD8 Targets2",
                   "SCZ DE",
                   "BD DE",
                   "ASD Excitatory",
                   "ASD Inhibitory",
                   "ASD Microglia",
                   "ASD Oligodendrocyte",
                   "ASD Astrocyte",
                   "ASD Endothelial",
                   "Ventricular Radial Glia",
                   "Outer Radial Glia",
                   "Cycling Progenitors S phase",
                   "Cycling Progenitors G2M phase",
                   "Intermediate Progenitors",
                   "Migrating Excitatory",
                   "Maturing Excitatory",
                   "Maturing Excitatory Upper Enriched",
                   "Excitatory Deep Layer 1",
                   "Excitatory Deep Layer 2",
                   "Interneuron MGE",
                   "Interneuron CGE",
                   "Oligodendrocyte Precursor Cells",
                   "Endothelial",
                   "Pericyte",
                   "Microglia")

res_colnames =  c("Non-Zero Modules","Zero Modules")
ORmat = data.frame(matrix(nrow = length(geneclasses), 
                          ncol = length(res_colnames)))
logPmat = data.frame(matrix(nrow = length(geneclasses), 
                            ncol = length(res_colnames)))
Pmat = data.frame(matrix(nrow = length(geneclasses), 
                         ncol = length(res_colnames)))
FDRmat = data.frame(matrix(nrow = length(geneclasses), 
                           ncol = length(res_colnames)))
colnames(ORmat) = res_colnames
colnames(logPmat) = res_colnames
colnames(Pmat) = res_colnames
colnames(FDRmat) = res_colnames
rownames(ORmat) = geneclassnames
rownames(logPmat) = geneclassnames
rownames(Pmat) = geneclassnames
rownames(FDRmat) = geneclassnames

tmp_cols = c("PROBE_ID","geneSymbol","moduleLabels","moduleColors","NonZeroMod",geneclassnames)
enrich_res_table = data.frame(matrix(nrow = dim(wgcna_res)[1], ncol = length(tmp_cols)))
colnames(enrich_res_table) = tmp_cols
enrich_res_table[,tmp_cols[1:4]] = wgcna_res[,tmp_cols[1:4]]
enrich_res_table[,"NonZeroMod"] = 0
enrich_res_table[is.element(enrich_res_table$moduleLabels,nonzeromods),"NonZeroMod"] = 1

for (i in 1:length(geneclasses)){
  # intersect with background list
  genes2 = geneclasses[[i]]
  mask = is.element(genes2,bglist)
  genes2 = data.frame(genes2[mask])

  overlap_res = genelistOverlap(nz_genes,
                                genes2,
                                backgroundTotal,
                                print_result = FALSE,
                                header = FALSE)
  ORmat[i,"Non-Zero Modules"] = overlap_res[[1]]$OR
  logPmat[i,"Non-Zero Modules"] = -log10(overlap_res[[1]]$hypergeo_p)
  Pmat[i,"Non-Zero Modules"] = overlap_res[[1]]$hypergeo_p
  
  genes2export = unique(as.character(overlap_res[[1]]$overlapping_genes))
  write(genes2export, 
        file = file.path(here("results",sprintf("%s_nonzero_overlap_SALV1.txt",geneclassnames[i]))))

  mask = is.element(enrich_res_table$geneSymbol,genes2export)
  enrich_res_table[, geneclassnames[i]] = 0
  enrich_res_table[mask, geneclassnames[i]] = 1
  
  # if (is.element(geneclassnames[i],c("PC1","PC2"))){
  #   genes2export = unique(as.character(overlap_res[[1]]$overlapping_genes))
  #   write(genes2export, 
  #         file = file.path(here("results",sprintf("%s_nonzero_overlap_SALV1.txt",geneclassnames[i]))))
  # }
  # 
  # if (is.element(geneclassnames[i],c("ASD CTX Downreg","ASD Prenatal1","FMRP Targets1",
  #                                  "FMRP Targets2","CHD8 Targets1","CHD8 Targets2",
  #                                  "Ventricular Radial Glia",
  #                                  "Outer Radial Glia",
  #                                  "Cycling Progenitors S phase",
  #                                  "Cycling Progenitors G2M phase",
  #                                  "Intermediate Progenitors",
  #                                  "Maturing Excitatory","Maturing Excitatory Upper Enriched",
  #                                  "Excitatory Deep Layer 1","Interneuron MGE","Song Bird DE"))){
  #   genes2export = unique(as.character(overlap_res[[1]]$overlapping_genes))
  #   write(genes2export, 
  #         file = file.path(here("results",sprintf("%s_nonzero_overlap_CTLV2.txt",geneclassnames[i]))))
  # }

  
  overlap_res = genelistOverlap(z_genes,
                                genes2,
                                backgroundTotal,
                                print_result = FALSE,
                                header = FALSE)
  ORmat[i,"Zero Modules"] = overlap_res[[1]]$OR
  logPmat[i,"Zero Modules"] = -log10(overlap_res[[1]]$hypergeo_p)
  Pmat[i,"Zero Modules"] = overlap_res[[1]]$hypergeo_p
}
for (i in 1:dim(Pmat)[2]){
  FDRmat[,i] = p.adjust(Pmat[,i], method = "fdr")
}

write.csv(enrich_res_table, file = here("results","enrich_res_table_SALV1.csv"))
```

# Enrichment with Song Bird DE genes

```{r, warning=FALSE, message=FALSE}
geneclassnames = c("Song Bird DE")

ORmat2use = ORmat[geneclassnames,]
Pmat2use = Pmat[geneclassnames,]
logPmat2use = logPmat[geneclassnames,]
FDRmat2use = FDRmat[geneclassnames,]

# Enrichment Odds Ratios
ORmat2use

# P-values
Pmat2use

# FDR
FDRmat2use
```


# Enrichment with human-specific genes

```{r, warning=FALSE, message=FALSE}
geneclassnames = c("Human-Specific Prenatal",
                   "Human-Specific Early Postnatal",
                   "Human-Specific Adult",
                   "Human-Accelerated Genes",
                   "Human-Gained Enhancers Fetal",
                   "Human-Gained Enhancers Adult",
                   "Human-Lossed Enhancers")

studyname = c("Zhu et al., 2018",
              "Zhu et al., 2018",
              "Zhu et al., 2018",
              "Won et al., 2019",
              "Won et al., 2019",
              "Won et al., 2019",
              "Won et al., 2019")

ORmat2use = ORmat[geneclassnames,]
Pmat2use = Pmat[geneclassnames,]
logPmat2use = logPmat[geneclassnames,]
FDRmat2use = FDRmat[geneclassnames,]

# make figure
pheatmap(logPmat2use, display_numbers = round(ORmat2use,digits=2), 
         number_color = "black", fontsize_number = 12,
         show_rownames=TRUE,
         labels_col = res_colnames,
         color = colorRampPalette(c('light blue','white','red'))(100),
         cluster_rows = FALSE, cluster_cols = FALSE,
         breaks= seq(0,-log10(0.005), length=100))


mat2use = logPmat2use
mat2use$labels = rownames(mat2use)
mat2use$cat = factor(studyname)
df4plot = melt(mat2use[,c("Non-Zero Modules","Zero Modules","labels","cat")])
mat2use = ORmat2use
mat2use$labels = rownames(mat2use)
tmp = melt(mat2use[,c("Non-Zero Modules","Zero Modules","labels")])
df4plot$OR = tmp$value
df4plot$labels = factor(df4plot$labels, levels = rev(geneclassnames))
df4plot$cat = factor(df4plot$cat, levels = rev(unique(studyname)))

p = ggplot(data = df4plot, aes(x = labels, y = value, fill=cat)) + facet_grid(. ~ variable)
p = p + geom_bar(stat="identity") + 
  ylab("-log10(p-value)") + 
  xlab(" ") + 
  geom_hline(yintercept = -log10(0.05)) +
  coord_flip() #+ 
  # scale_fill_gradientn(colors = colorRampPalette(c("white","red"))(100))
p


fs2use = fontSize-5
p = ggplot(data = df4plot, aes(x = labels, y = value, fill=OR)) + facet_grid(. ~ variable)
p = p + geom_bar(stat="identity", colour="black") + 
  ylab("-log10(p-value)") + 
  xlab(" ") + 
  geom_hline(yintercept = -log10(0.01), linetype="dashed") +
  scale_fill_gradientn(colors = colorRampPalette(c("white","red"))(100), 
                       limits = c(min(df4plot$OR),max(df4plot$OR))) +
  coord_flip() + 
  # scale_fill_gradientn(colors = colorRampPalette(c("white","red"))(100))
  theme(axis.text.x = element_text(size=fs2use),
        # axis.text.y = element_text(size=fs2use),
        axis.title.x = element_text(size=fs2use),
        strip.text.x = element_text(size=fs2use),
        plot.title = element_text(size=fs2use,hjust=0.5))
ggsave(filename = file.path(plotdir,"humanspecific_enrichment_SA_LV1.pdf"))
p

# Enrichment Odds Ratios
ORmat2use

# P-values
Pmat2use

# FDR
FDRmat2use
```


# Enrichment in prenatal gradient expression

```{r, warning=FALSE, message=FALSE}
geneclassnames = c("PC1",
                   "PC2")

ORmat2use = ORmat[geneclassnames,]
Pmat2use = Pmat[geneclassnames,]
logPmat2use = logPmat[geneclassnames,]
FDRmat2use = FDRmat[geneclassnames,]

# make figure
pheatmap(logPmat2use, display_numbers = round(ORmat2use,digits=2), 
         number_color = "black", fontsize_number = fontSize,
         show_rownames=TRUE,
         labels_col = res_colnames,
         color = colorRampPalette(c('light blue','white','red'))(100),
         cluster_rows = FALSE, cluster_cols = FALSE,
         fontsize_row = fontSize, fontsize_col = fontSize,
         breaks= seq(0,-log10(0.005), length=100))

mat2use = logPmat2use
mat2use$labels = rownames(mat2use)
df4plot = melt(mat2use[,c("Non-Zero Modules","Zero Modules","labels")])
mat2use = ORmat2use
mat2use$labels = rownames(mat2use)
tmp = melt(mat2use[,c("Non-Zero Modules","Zero Modules","labels")])
df4plot$OR = tmp$value
df4plot$labels = factor(df4plot$labels, levels = rev(geneclassnames))

p = ggplot(data = df4plot, aes(x = labels, y = value)) + facet_grid(. ~ variable)
p = p + geom_bar(stat="identity") + 
  ylab("-log10(p-value)") + 
  xlab(" ") + 
  geom_hline(yintercept = -log10(0.05)) +
  coord_flip() #+ 
  # scale_fill_gradientn(colors = colorRampPalette(c("white","red"))(100))
p = p +  theme(text = element_text(size=fontSize), 
        axis.text.x = element_text(size=fontSize),
        axis.text.y = element_text(size=fontSize))
p


# Enrichment Odds Ratios
ORmat2use

# P-values
Pmat2use

# FDR
FDRmat2use
```



# Examine enrichment between non-zero or zero modules and song bird DE, Human Specific, ASD Prenatal, ASD CTX Dysregulated Modules, ASD PTVs, ASD SFARI, and FMRP and CHD8 targets

```{r, warning=FALSE, message=FALSE}
geneclassnames = c("ASD 102 dnPTVs",
                   "SFARI ASD",
                   "ASD DE Downreg",
                   "ASD DE Upreg",
                   "ASD CTX Downreg",
                   "ASD CTX Upreg",
                   "ASD Prenatal1",
                   "FMRP Targets1",
                   "FMRP Targets2",
                   "CHD8 Targets1",
                   "CHD8 Targets2",
                   "SCZ DE",
                   "BD DE")

ORmat2use = ORmat[geneclassnames,]
Pmat2use = Pmat[geneclassnames,]
logPmat2use = logPmat[geneclassnames,]
FDRmat2use = FDRmat[geneclassnames,]

# make figure
pheatmap(logPmat2use, display_numbers = round(ORmat2use,digits=2), 
         number_color = "black", fontsize_number = 12,
         show_rownames=TRUE,
         labels_col = res_colnames,
         color = colorRampPalette(c('light blue','white','red'))(100),
         cluster_rows = FALSE, cluster_cols = FALSE,
         breaks= seq(0,-log10(0.005), length=100))

mat2use = logPmat2use
mat2use$labels = rownames(mat2use)
df4plot = melt(mat2use[,c("Non-Zero Modules","Zero Modules","labels")])
mat2use = ORmat2use
mat2use$labels = rownames(mat2use)
tmp = melt(mat2use[,c("Non-Zero Modules","Zero Modules","labels")])
df4plot$OR = tmp$value
df4plot$labels = factor(df4plot$labels, levels = rev(geneclassnames))

p = ggplot(data = df4plot, aes(x = labels, y = value)) + facet_grid(. ~ variable)
p = p + geom_bar(stat="identity") + 
  ylab("-log10(p-value)") + 
  xlab(" ") + 
  geom_hline(yintercept = -log10(0.05)) +
  coord_flip() #+ 
  # scale_fill_gradientn(colors = colorRampPalette(c("white","red"))(100))
p

fs2use = fontSize-5
p = ggplot(data = df4plot, aes(x = labels, y = value, fill=OR)) + facet_grid(. ~ variable)
p = p + geom_bar(stat="identity", colour="black") + 
  ylab("-log10(p-value)") + 
  xlab(" ") + 
  geom_hline(yintercept = -log10(0.01), linetype="dashed") +
  scale_fill_gradientn(colors = colorRampPalette(c("white","red"))(100), 
                       limits = c(min(df4plot$OR),max(df4plot$OR))) +
  ylim(0,42) + 
  coord_flip() + 
  # scale_fill_gradientn(colors = colorRampPalette(c("white","red"))(100))
  theme(axis.text.x = element_text(size=fs2use),
        # axis.text.y = element_text(size=fs2use),
        axis.title.x = element_text(size=fs2use),
        strip.text.x = element_text(size=fs2use),
        plot.title = element_text(size=fs2use,hjust=0.5))
ggsave(filename = file.path(plotdir,"asdgenelist_enrichment_SA_LV1.pdf"))
p

# Enrichment Odds Ratios
ORmat2use

# P-values
Pmat2use

# FDR
FDRmat2use
```

# Examine enrichment between ASD DE cell-type lists (Velmeshev et al.,)

```{r, warning=FALSE, message=FALSE}
geneclassnames = c("ASD Excitatory",
                   "ASD Inhibitory",
                   "ASD Microglia",
                   "ASD Oligodendrocyte",
                   "ASD Astrocyte",
                   "ASD Endothelial")

ORmat2use = ORmat[geneclassnames,]
Pmat2use = Pmat[geneclassnames,]
logPmat2use = logPmat[geneclassnames,]
FDRmat2use = FDRmat[geneclassnames,]

# make figure
pheatmap(logPmat2use, display_numbers = round(ORmat2use,digits=2), 
         number_color = "black", fontsize_number = 12,
         show_rownames=TRUE,
         labels_col = res_colnames,
         color = colorRampPalette(c('light blue','white','red'))(100),
         cluster_rows = FALSE, cluster_cols = FALSE,
         breaks= seq(0,-log10(0.005), length=100))

mat2use = logPmat2use
mat2use$labels = rownames(mat2use)
df4plot = melt(mat2use[,c("Non-Zero Modules","Zero Modules","labels")])
mat2use = ORmat2use
mat2use$labels = rownames(mat2use)
tmp = melt(mat2use[,c("Non-Zero Modules","Zero Modules","labels")])
df4plot$OR = tmp$value

fs2use = fontSize-5
df4plot$labels = factor(df4plot$labels, levels = rev(geneclassnames))
p = ggplot(data = df4plot, aes(x = labels, y = value, fill=OR)) + facet_grid(. ~ variable)
p = p + geom_bar(stat="identity", colour="black") + 
  ylab("-log10(p-value)") + 
  xlab(" ") + 
  geom_hline(yintercept = -log10(0.01), linetype="dashed") +
  scale_fill_gradientn(colors = colorRampPalette(c("white","red"))(100), 
                       limits = c(min(df4plot$OR),max(df4plot$OR))) +
  ylim(0,3) + 
  coord_flip() + 
  # scale_fill_gradientn(colors = colorRampPalette(c("white","red"))(100))
  theme(axis.text.x = element_text(size=fs2use),
        # axis.text.y = element_text(size=fs2use),
        axis.title.x = element_text(size=fs2use),
        strip.text.x = element_text(size=fs2use),
        plot.title = element_text(size=fs2use,hjust=0.5))
ggsave(filename = file.path(plotdir,"asdcelltypes_enrichment_SA_LV1.pdf"))
p


# Enrichment Odds Ratios
ORmat2use

# P-values
Pmat2use

# FDR
FDRmat2use
```

# Examine enrichment between prenatal cell-type lists

```{r, warning=FALSE, message=FALSE}
geneclassnames = c("Ventricular Radial Glia",
                   "Outer Radial Glia",
                   "Cycling Progenitors S phase",
                   "Cycling Progenitors G2M phase",
                   "Intermediate Progenitors",
                   "Migrating Excitatory",
                   "Maturing Excitatory",
                   "Maturing Excitatory Upper Enriched",
                   "Excitatory Deep Layer 1",
                   "Excitatory Deep Layer 2",
                   "Interneuron MGE",
                   "Interneuron CGE",
                   "Oligodendrocyte Precursor Cells",
                   "Endothelial",
                   "Pericyte",
                   "Microglia")

genetypecat = c("Progenitor",
                "Progenitor",
                "Progenitor",
                "Progenitor",
                "Progenitor",
                "Excitatory",
                "Excitatory",
                "Excitatory",
                "Excitatory",
                "Excitatory",
                "Inhibitory",
                "Inhibitory",
                "Other",
                "Other",
                "Other",
                "Other")

ORmat2use = ORmat[geneclassnames,]
Pmat2use = Pmat[geneclassnames,]
logPmat2use = logPmat[geneclassnames,]
FDRmat2use = FDRmat[geneclassnames,]

# make figure
pheatmap(logPmat2use, display_numbers = round(ORmat2use,digits=2), 
         number_color = "black", fontsize_number = 12,
         show_rownames=TRUE,
         labels_col = res_colnames,
         color = colorRampPalette(c('light blue','white','red'))(100),
         cluster_rows = FALSE, cluster_cols = FALSE,
         breaks= seq(0,-log10(0.005), length=100))

# make bar plot
mat2use = logPmat2use
mat2use$labels = rownames(mat2use)
mat2use$cat = genetypecat
mat2use$labels = factor(mat2use$labels, levels = rev(geneclassnames))
mat2use$cat = factor(mat2use$cat, levels = rev(unique(genetypecat)))
df4plot = melt(mat2use[,c("Non-Zero Modules","Zero Modules","labels","cat")])
mat2use = ORmat2use
mat2use$labels = rownames(mat2use)
tmp = melt(mat2use[,c("Non-Zero Modules","Zero Modules","labels")])
df4plot$OR = tmp$value

p = ggplot(data = df4plot, aes(x = labels, y = value, fill=cat)) + facet_grid(. ~ variable)
p = p + geom_bar(stat="identity") + 
  ylab("-log10(p-value)") + 
  xlab(" ") + 
  geom_hline(yintercept = -log10(0.01)) +
  coord_flip() #+ 
  # scale_fill_gradientn(colors = colorRampPalette(c("white","red"))(100))
p

fs2use = fontSize-5
p = ggplot(data = df4plot, aes(x = labels, y = value, fill=OR)) + facet_grid(. ~ variable)
p = p + geom_bar(stat="identity", colour="black") + 
  ylab("-log10(p-value)") + 
  xlab(" ") + ggtitle("SA LV1") +
  geom_hline(yintercept = -log10(0.01), linetype = "dashed") +
  scale_fill_gradientn(colors = colorRampPalette(c("white","red"))(100), 
                       limits = c(min(df4plot$OR),max(df4plot$OR))) +
  ylim(0,30) + 
  coord_flip() +
  # theme(text = element_text(size=fs2use),
  theme(axis.text.x = element_text(size=fs2use),
        # axis.text.y = element_text(size=fs2use),
        axis.title.x = element_text(size=fs2use),
        strip.text.x = element_text(size=fs2use),
        plot.title = element_text(size=fs2use,hjust=0.5))
  # scale_fill_gradientn(colors = colorRampPalette(c("white","red"))(100))
ggsave(filename = file.path(plotdir, "prenatalCellTypes_enrichments_SA_LV1.pdf"))
p

# Enrichment Odds Ratios
ORmat2use

# P-values
Pmat2use

# FDR
FDRmat2use
```

# Assess enrichments with individual modules

```{r, warning=FALSE, message=FALSE}
geneclasses = list(HumanSpecific_Prenatal_Zhu,
                   HumanSpecific_EarlyPostnatal_Zhu,
                   HumanSpecific_Adult_Zhu,
                   won_har_genes,
                   won_hge_fetal_genes,
                   won_hge_adult_genes,
                   won_hle_genes,
                   W234_PC1,
                   W234_PC2,
                   SongBirdDE,
                   ASDPrenatal1,
                   gandal_asd_down,
                   gandal_asd_up,
                   ASDCTXDownreg,
                   ASDCTXUpreg,
                   ASD102,
                   SFARIASD,
                   FMRP1,
                   FMRP2,
                   CHD81,
                   CHD82,
                   gandal_scz,
                   gandal_bd,
                   excitatory_de_genes,
                   inhibitory_de_genes,
                   microglia_de_genes,
                   oligodendrocyte_de_genes,
                   astrocyte_de_genes,
                   endothelial_de_genes,
                   vRG,oRG,PgS,PgG2M,IP,
                   ExN,ExM,ExMU,ExDp1,ExDp2,
                   InMGE,InCGE,
                   OPC,End,Per,Mic)

geneclassnames = c("Human-Specific Prenatal",
                   "Human-Specific Early Postnatal",
                   "Human-Specific Adult",
                   "Human-Accelerated Genes",
                   "Human-Gained Enhancers Fetal",
                   "Human-Gained Enhancers Adult",
                   "Human-Lossed Enhancers",
                   "PC1",
                   "PC2",
                   "Song Bird DE",
                   "ASD Prenatal1",
                   "ASD DE Downreg",
                   "ASD DE Upreg",
                   "ASD CTX Downreg",
                   "ASD CTX Upreg",
                   "ASD 102 dnPTVs",
                   "SFARI ASD",
                   "FMRP Targets1",
                   "FMRP Targets2",
                   "CHD8 Targets1",
                   "CHD8 Targets2",
                   "SCZ DE",
                   "BD DE",
                   "ASD Excitatory",
                   "ASD Inhibitory",
                   "ASD Microglia",
                   "ASD Oligodendrocyte",
                   "ASD Astrocyte",
                   "ASD Endothelial",
                   "Ventricular Radial Glia",
                   "Outer Radial Glia",
                   "Cycling Progenitors S phase",
                   "Cycling Progenitors G2M phase",
                   "Intermediate Progenitors",
                   "Migrating Excitatory",
                   "Maturing Excitatory",
                   "Maturing Excitatory Upper Enriched",
                   "Excitatory Deep Layer 1",
                   "Excitatory Deep Layer 2",
                   "Interneuron MGE",
                   "Interneuron CGE",
                   "Oligodendrocyte Precursor Cells",
                   "Endothelial",
                   "Pericyte",
                   "Microglia")

ORmat = data.frame(matrix(nrow = length(mod_names),
                          ncol = length(geneclasses)))
colnames(ORmat) = geneclassnames
rownames(ORmat) = mod_names

Pmat = data.frame(matrix(nrow = length(mod_names),
                         ncol = length(geneclasses)))
colnames(Pmat) = geneclassnames
rownames(Pmat) = mod_names

FDRmat = data.frame(matrix(nrow = length(mod_names),
                           ncol = length(geneclasses)))
colnames(FDRmat) = geneclassnames
rownames(FDRmat) = mod_names

for (imod in 1:length(mod_names)){
  for (igc in 1:length(geneclasses)){
    # intersect geneclass list with background
    genes2 = geneclasses[[igc]]
    mask = is.element(genes2,bglist)
    genes2 = data.frame(genes2[mask])

    modulegenes = wgcna_res$geneSymbol[wgcna_res$moduleLabels==imod]

    overlap_res = genelistOverlap(modulegenes,
                                  genes2,
                                  backgroundTotal,
                                  print_result = FALSE,
                                  header = FALSE)
    ORmat[imod,igc] = overlap_res[[1]]$OR
    Pmat[imod,igc] = overlap_res[[1]]$hypergeo_p
  }
}
for (i in 1:dim(Pmat)[2]){
  FDRmat[,i] = p.adjust(Pmat[,i], method = "fdr")
}

# Enrichment Odds Ratios
ORmat

# P-values
Pmat

# FDR
FDRmat
```


# Find consensus genes

SA LV1 non-zero & Prenatal Progenitor & Prenatal PC1 (A-P) & ASD Prenatal CoExpMod

```{r, warning=FALSE, message=FALSE}
progenitor_list = unique(c(vRG,oRG,PgS,PgG2M,IP))

progen_pc1_list = progenitor_list[is.element(progenitor_list,W234_PC1)]
progen_pc1_asdprenatal_list = progen_pc1_list[is.element(progen_pc1_list,ASDPrenatal1)]

progen_pc1_asdprenatal_salv1_list = progen_pc1_asdprenatal_list[is.element(progen_pc1_asdprenatal_list,nz_genes)]
sort(progen_pc1_asdprenatal_salv1_list)

# overlap with SFARI ASD genes
progen_pc1_asdprenatal_SFARI_salv1_list = progen_pc1_asdprenatal_salv1_list[is.element(progen_pc1_asdprenatal_salv1_list,SFARIASD)]
sort(progen_pc1_asdprenatal_SFARI_salv1_list)
```


SA LV1 non-zero & Human-specific & Prenatal Progenitor & Prenatal PC1 (A-P) & ASD Prenatal CoExpMod

```{r, warning=FALSE, message=FALSE}
hs_list = unique(c(HumanSpecific_Prenatal_Zhu,
                        HumanSpecific_EarlyPostnatal_Zhu,
                        HumanSpecific_Adult_Zhu))
progenitor_list = unique(c(vRG,oRG,PgS,PgG2M,IP))

hs_progen_list = hs_list[is.element(hs_list,progenitor_list)]
hs_progen_pc1_list = hs_progen_list[is.element(hs_progen_list,W234_PC1)]
hs_progen_pc1_asdprenatal_list = hs_progen_pc1_list[is.element(hs_progen_pc1_list,ASDPrenatal1)]
# hs_progen_pc1_asdprenatal_vocal_list = hs_progen_pc1_asdprenatal_list[is.element(hs_progen_pc1_asdprenatal_list,SongBirdDE)]

hs_progen_pc1_asdprenatal_salv1_list = hs_progen_pc1_asdprenatal_list[is.element(hs_progen_pc1_asdprenatal_list,nz_genes)]
sort(hs_progen_pc1_asdprenatal_salv1_list)

# overlap with SFARI ASD genes
hs_progen_pc1_asdprenatal_SFARI_salv1_list = hs_progen_pc1_asdprenatal_salv1_list[is.element(hs_progen_pc1_asdprenatal_salv1_list,SFARIASD)]
sort(hs_progen_pc1_asdprenatal_SFARI_salv1_list)
```


SA LV1 non-zero & Human-specific & Vocal Learning

```{r, warning=FALSE, message=FALSE}
hs_list = unique(c(HumanSpecific_Prenatal_Zhu,
                        HumanSpecific_EarlyPostnatal_Zhu,
                        HumanSpecific_Adult_Zhu))

hs_vocal_list = hs_list[is.element(hs_list,SongBirdDE)]

hs_vocal_salv1_list = hs_vocal_list[is.element(hs_vocal_list,nz_genes)]
sort(hs_vocal_salv1_list)

# overlap with SFARI ASD genes
hs_vocal_SFARI_salv1_list = hs_vocal_salv1_list[is.element(hs_vocal_salv1_list,SFARIASD)]
sort(hs_vocal_SFARI_salv1_list)
```
